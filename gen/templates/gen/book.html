{% extends "base.html" %}

{% block title %}{{ book.title }} - LitLounge{% endblock %}

{% block content %}
<h2>{{ book.title }}</h2>
<p id="inline-block-child">By {{ book.author }} |</p>
<p id="inline-block-child">Genre: {{ book.genre }} |</p>
<p id="inline-block-child">Publishing date: {{ book.publishing_date }}</p>
<div id="middle">
    <p id="blurb">{{ book.blurb }}</p>
    <img id="inline-block-child" src="{{ book.cover_link }}" height="400" width="267">
</div>
<h2>Reviews</h2>
{% set count = 0 %}
{% set nsg = namespace(count=count) %}
<hr>
{% for review in reviews %}
    {% if book.id == review.bookID %}
        {% for user in users %}
            {% if user.id == review.userID %}
                <br>
                <h2>{{ review.title }}</h2>
                <ul>
                <li><p id="inline-block-child">By {{ user.username }}</p></li>
                <li><img id="inline-block-child2" src="{{ url_for('static', filename=user.profile_picture) }}" width="50" height="40"></li>
                <li><p id="inline-block-child">{{ review.publishing_date }}</p></li>
                {% for i in range(0, review.rating|int) %}
                    <svg width="23" height="25">
                        <polygon id="yellowStar" points="12.5, 1.25 5.0, 24.75 23.75, 9.75 1.25, 9.75 20.0, 24.75"/>
                    </svg>
                {%endfor%}
                {% if review.rating|float % 1 != 0 %}
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="23" height="25">
                        <defs>
                        <linearGradient id="grad">
                            <stop offset="50%" stop-color="#fbff00"/>
                            <stop offset="50%" stop-color="#989898"/>
                        </linearGradient>
                        </defs>
                        <polygon fill="url(#grad)" points="12.5, 1.25 5.0, 24.75 23.75, 9.75 1.25, 9.75 20.0, 24.75"/>
                    </svg>
                {% endif %}
                {% for i in range(0, 4 - review.rating|int) %}
                    <svg width="23" height="25">
                        <polygon id="greyStar" points="12.5, 1.25 5.0, 24.75 23.75, 9.75 1.25, 9.75 20.0, 24.75"/>
                    </svg>
                {%endfor%}
                </ul>
                <br>
                <br>
                <p>{{ review.text }}</p>
                <br>
                {% set likeCount = 0 %}
                {% set ns = namespace(likeCount=likeCount) %}
                    {% for like in likes %}
                        {% if review.id == like.reviewID %}
                            {% set ns.likeCount = ns.likeCount|int + like.like|int %}
                        {% endif %}
                    {% endfor %}
                <form method="POST" action="/like" id="like-form">
                    <input type="hidden" name="reviewID" id="reviewID" value="{{ review.id }}">
                    <button type="submit" id="like{{ nsg.count }}">👍{{ ns.likeCount }}</button>
                </form>
                <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
                <script type="text/javascript">
                    $(document).on('submit','#like-form',function(e)
                                {
                    e.preventDefault();
                    $.ajax({
                        type:'POST',
                        url:'/like',
                        data:{
                        reviewID:$("#reviewID").val()
                        },
                        success:function()
                        {
                            let count = document.getElementById("like{{ nsg.count }}").textContent.replace("👍", "");
                            document.getElementById("like{{ nsg.count }}").innerHTML = "👍" + (Number(count) + 1);
                        }
                        })
                    });
                </script>
                {% set dislikeCount = 0 %}
                {% set ns = namespace(dislikeCount=dislikeCount) %}
                    {% for like in likes %}
                        {% if review.id == like.reviewID %}
                            {% set ns.dislikeCount = ns.dislikeCount|int + like.dislike|int %}
                        {% endif %}
                    {% endfor %}
                <form method="POST" action="/dislike" id="dislike-form">
                    <input type="hidden" name="reviewID" value="{{ review.id }}">
                    <button type="submit" id="dislike{{ nsg.count }}">👎{{ ns.dislikeCount }}</button>
                </form>
                <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
                <script type="text/javascript">
                    $(document).on('submit','#dislike-form',function(e)
                                {
                    e.preventDefault();
                    $.ajax({
                        type:'POST',
                        url:'/dislike',
                        data:{
                        reviewID:$("#reviewID").val()
                        },
                        success:function()
                        {
                            let count = document.getElementById("dislike{{ nsg.count }}").textContent.replace("👎", "");
                            document.getElementById("dislike{{ nsg.count }}").innerHTML = "👎" + (Number(count) + 1);
                        }
                        })
                    });
                </script>
            {% endif %}
        {% endfor %}
    {% endif %}
    {% set nsg.count = nsg.count|int + 1 %}
{% endfor %}
<form method="POST" action="/review">
    <input type="text" placeholder="Title" name="title" required>
    <input type="range" name="rating" min="0.5" max="5" step="0.5" value="5" class="rating" style="--val:5" oninput="this.style='--val:'+this.value" required>
    <br>
    <p>Bio</p>
    <textarea name="review" required></textarea>
    <br>
    <button type="submit">Make a review</button>
</form>

{% endblock %}